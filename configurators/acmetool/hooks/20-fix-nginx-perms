#!/bin/bash
set -euo pipefail

LIVE_BASE="/var/lib/acme/live"
GROUP="ssl-cert"
NGINX_USER="www-data"

log() { logger -t acmetool-hook-fix-perms "$*"; }

# Ensure group & membership
getent group "$GROUP" >/dev/null || addgroup --system "$GROUP" || true

# Add user to group if not already
id -nG "$NGINX_USER" | tr ' ' '\n' | grep -qx "$GROUP" || usermod -a -G "$GROUP" "$NGINX_USER" || true

# Ensure traversal
chmod 0711 /var/lib/acme 2>/dev/null || true
chmod 0711 /var/lib/acme/live 2>/dev/null || true

changed=0
for dir in "$LIVE_BASE"/*; do
    [ -d "$dir" ] || continue
    chmod 0711 "$dir" 2>/dev/null || true
    for f in privkey account; do
        file="$dir/$f"
        [ -f "$file" ] || continue
        chown root:"$GROUP" "$file"
        chmod 0640 "$file"
        changed=$((changed+1))
    done
done

log "Adjusted permissions on $changed file(s)"
systemctl is-active --quiet nginx && systemctl reload nginx || true
exit 0
